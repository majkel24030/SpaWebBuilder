version: 2

services:
  backend:
    source: backend
    build:
      command: pip install -r requirements.txt
    start:
      command: uvicorn app.main:app --host 0.0.0.0 --port $PORT
    variables:
      PYTHON_VERSION: 3.11
      ENVIRONMENT: production
      ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: 30
    healthcheck:
      path: /api/health
      interval: 30s
      timeout: 10s
      retries: 3

  frontend:
    source: frontend
    build:
      command: npm install && npm run build:render
    start:
      command: npx serve -s dist -l $PORT --single
    variables:
      NODE_VERSION: 18
    depends_on:
      - backend

  database:
    image: postgres:15
    variables:
      POSTGRES_DB: windoor_config
      POSTGRES_USER: windoor_user
    volumes:
      - /var/lib/postgresql/data

# Auto-generated environment variables that Railway will create:
# ${{DATABASE_URL}} - PostgreSQL connection string
# ${{RAILWAY_STATIC_URL}} - Frontend URL
# ${{RAILWAY_SERVICE_URL}} - Backend URL